#!/bin/bash
# certcat - Web-enhanced certificate inspector for jterm
# Usage: certcat <source> [options]

# Default values
SOURCE=""
INCLUDE_CHAIN=true
COMPARE_WITH=""

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --no-chain)
            INCLUDE_CHAIN=false
            shift
            ;;
        --compare)
            COMPARE_WITH="$2"
            shift 2
            ;;
        --help|-h)
            echo "Usage: certcat <source> [options]"
            echo "Source can be:"
            echo "  https://example.com     - Remote HTTPS endpoint"
            echo "  /path/to/cert.pem       - Local PEM certificate file"
            echo "  /path/to/cert.crt       - Local CRT certificate file"
            echo ""
            echo "Options:"
            echo "  --no-chain            Don't include certificate chain"
            echo "  --compare SOURCE2     Compare with another certificate"
            echo "  --help, -h            Show this help message"
            echo ""
            echo "Examples:"
            echo "  certcat https://google.com"
            echo "  certcat /etc/ssl/certs/cert.pem"
            echo "  certcat google.com --compare facebook.com"
            exit 0
            ;;
        -*)
            echo "Unknown option: $1" >&2
            exit 1
            ;;
        *)
            if [[ -z "$SOURCE" ]]; then
                SOURCE="$1"
            else
                echo "Too many arguments" >&2
                exit 1
            fi
            shift
            ;;
    esac
done

# Validate required arguments
if [[ -z "$SOURCE" ]]; then
    echo "Error: No certificate source specified" >&2
    echo "Usage: certcat <source> [options]" >&2
    exit 1
fi

# Normalize source - add https:// if it's a hostname without protocol
if [[ "$SOURCE" != /* && "$SOURCE" != https://* && "$SOURCE" != http://* ]]; then
    SOURCE="https://$SOURCE"
fi

# Convert file paths to absolute paths
if [[ "$SOURCE" == /* ]]; then
    # It's a file path, check if it exists
    if [[ ! -f "$SOURCE" ]]; then
        echo "Error: Certificate file not found: $SOURCE" >&2
        exit 1
    fi
fi

# Handle comparison source
if [[ -n "$COMPARE_WITH" ]]; then
    # Normalize comparison source
    if [[ "$COMPARE_WITH" != /* && "$COMPARE_WITH" != https://* && "$COMPARE_WITH" != http://* ]]; then
        COMPARE_WITH="https://$COMPARE_WITH"
    fi

    # Convert file paths to absolute paths
    if [[ "$COMPARE_WITH" == /* ]]; then
        if [[ "$COMPARE_WITH" != /* ]]; then
            COMPARE_WITH="$(pwd)/$COMPARE_WITH"
        fi
        # Check if comparison file exists
        if [[ ! -f "$COMPARE_WITH" ]]; then
            echo "Error: Comparison certificate file not found: $COMPARE_WITH" >&2
            exit 1
        fi
    fi
fi

# Build JSON payload for OSC sequence
# T028: Updated to send JSON payload matching terminal.js handler
if [[ -n "$COMPARE_WITH" ]]; then
    JSON_PAYLOAD=$(cat <<EOF
{"source":"$SOURCE","includeChain":$INCLUDE_CHAIN,"compareWith":"$COMPARE_WITH"}
EOF
)
else
    JSON_PAYLOAD=$(cat <<EOF
{"source":"$SOURCE","includeChain":$INCLUDE_CHAIN}
EOF
)
fi

# Send OSC 1337 sequence to trigger certificate viewer
# Format: \033]1337;ViewCert=<json>\007
printf '\033]1337;ViewCert=%s\007' "$JSON_PAYLOAD"