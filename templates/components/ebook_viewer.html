<!-- Ebook Viewer Component - HTMX template for PDF/EPUB viewing with foliate-js -->

<!-- Main Ebook Viewer Modal -->
<div class="ebook-viewer" id="ebook-viewer-{{ ebook_id }}" data-ebook-id="{{ ebook_id }}" data-file-type="{{ file_type }}">
    <!-- Header with file info and controls -->
    <div class="ebook-header">
        <div class="ebook-info">
            <span class="icon">{{ 'üìï' if file_type == 'pdf' else 'üìó' }}</span>
            <div class="ebook-title-group">
                <span class="ebook-title">{{ title or file_name }}</span>
                {% if author %}
                <span class="ebook-author">by {{ author }}</span>
                {% endif %}
            </div>
            <span class="ebook-meta">
                {% if total_pages %}{{ total_pages }} pages{% endif %}
                {% if file_size %} ‚Ä¢ {{ file_size }}{% endif %}
            </span>
        </div>
        <div class="ebook-controls">
            <button class="btn btn-icon"
                    id="ebook-search-toggle-{{ ebook_id }}"
                    _="on click toggle .search-visible on #ebook-viewer-{{ ebook_id }}"
                    title="Search">
                <span class="icon">üîç</span>
            </button>
            <button class="btn btn-icon"
                    id="ebook-toc-toggle-{{ ebook_id }}"
                    _="on click toggle .toc-visible on #ebook-viewer-{{ ebook_id }}"
                    title="Table of Contents">
                <span class="icon">üìë</span>
            </button>
            <button class="btn btn-icon"
                    id="ebook-fullscreen-{{ ebook_id }}"
                    _="on click toggle .fullscreen on #ebook-viewer-{{ ebook_id }}"
                    title="Fullscreen">
                <span class="icon">‚õ∂</span>
            </button>
            <button class="btn btn-icon"
                    hx-get="/api/ebooks/{{ ebook_id }}/content"
                    hx-headers='{"Accept": "application/octet-stream"}'
                    title="Download">
                <span class="icon">‚¨áÔ∏è</span>
            </button>
            <button class="btn btn-icon close-btn"
                    _="on click remove #ebook-viewer-{{ ebook_id }}"
                    title="Close">
                <span class="icon">‚úï</span>
            </button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="ebook-container">
        <!-- Table of Contents Sidebar (hidden by default) -->
        <div class="ebook-toc" id="ebook-toc-{{ ebook_id }}">
            <div class="toc-header">
                <h4>Contents</h4>
                <button class="btn btn-icon btn-sm"
                        _="on click toggle .toc-visible on #ebook-viewer-{{ ebook_id }}">
                    <span class="icon">‚úï</span>
                </button>
            </div>
            <nav class="toc-nav" id="ebook-toc-nav-{{ ebook_id }}">
                <!-- TOC items will be populated by JavaScript after book loads -->
                <div class="toc-loading">Loading contents...</div>
            </nav>
        </div>

        <!-- Ebook Content (foliate-js viewer) -->
        <div class="ebook-content" id="ebook-content-{{ ebook_id }}">
            <!-- Loading indicator -->
            <div class="ebook-loading" id="ebook-loading-{{ ebook_id }}">
                <div class="loading-spinner"></div>
                <p>Loading ebook...</p>
                <div class="loading-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="ebook-progress-{{ ebook_id }}" style="width: 0%"></div>
                    </div>
                    <span class="progress-text" id="ebook-progress-text-{{ ebook_id }}">0%</span>
                </div>
            </div>

            <!-- foliate-js viewer container (populated by JavaScript) -->
            <div class="foliate-viewer-container"
                 id="foliate-viewer-{{ ebook_id }}"
                 data-ebook-url="/api/ebooks/{{ ebook_id }}/content"
                 style="display: none;">
            </div>

            <!-- Error display (if loading fails) -->
            <div class="ebook-error" id="ebook-error-{{ ebook_id }}" style="display: none;">
                <span class="error-icon">‚ö†Ô∏è</span>
                <h3>Failed to load ebook</h3>
                <p class="error-message" id="ebook-error-message-{{ ebook_id }}"></p>
                <button class="btn btn-primary"
                        _="on click call ebookViewer.retry('{{ ebook_id }}')">
                    Retry
                </button>
            </div>
        </div>
    </div>

    <!-- Search Bar (hidden by default) -->
    <div class="ebook-search" id="ebook-search-{{ ebook_id }}">
        <input type="text"
               class="search-input"
               id="ebook-search-input-{{ ebook_id }}"
               placeholder="Search in book..."
               _="on input debounced at 300ms
                  call ebookViewer.search('{{ ebook_id }}', my value)
                  on keydown
                    if event.key is 'Escape'
                      then toggle .search-visible on #ebook-viewer-{{ ebook_id }}"
               autocomplete="off">
        <div class="search-results">
            <span class="search-count" id="ebook-search-count-{{ ebook_id }}">0 results</span>
            <div class="search-nav">
                <button class="btn btn-sm"
                        _="on click call ebookViewer.searchPrev('{{ ebook_id }}')"
                        title="Previous">
                    ‚Üë
                </button>
                <button class="btn btn-sm"
                        _="on click call ebookViewer.searchNext('{{ ebook_id }}')"
                        title="Next">
                    ‚Üì
                </button>
            </div>
        </div>
        <button class="btn btn-icon btn-sm"
                _="on click toggle .search-visible on #ebook-viewer-{{ ebook_id }}">
            <span class="icon">‚úï</span>
        </button>
    </div>

    <!-- Navigation Footer -->
    <div class="ebook-footer">
        <div class="ebook-navigation">
            <button class="btn btn-icon"
                    id="ebook-prev-{{ ebook_id }}"
                    _="on click call ebookViewer.prevPage('{{ ebook_id }}')"
                    title="Previous Page"
                    disabled>
                <span class="icon">‚óÑ</span>
            </button>

            <div class="page-controls">
                <span class="page-info" id="ebook-page-info-{{ ebook_id }}">
                    Page <input type="number"
                               class="page-input"
                               id="ebook-page-input-{{ ebook_id }}"
                               value="1"
                               min="1"
                               max="{{ total_pages or 999 }}"
                               _="on change call ebookViewer.gotoPage('{{ ebook_id }}', my value)">
                    of <span id="ebook-total-pages-{{ ebook_id }}">{{ total_pages or '...' }}</span>
                </span>
            </div>

            <button class="btn btn-icon"
                    id="ebook-next-{{ ebook_id }}"
                    _="on click call ebookViewer.nextPage('{{ ebook_id }}')"
                    title="Next Page">
                <span class="icon">‚ñ∫</span>
            </button>
        </div>

        <div class="ebook-actions">
            <!-- Reading progress indicator -->
            <div class="reading-progress">
                <span class="progress-label">Progress:</span>
                <div class="progress-bar-mini">
                    <div class="progress-fill-mini" id="ebook-reading-progress-{{ ebook_id }}" style="width: 0%"></div>
                </div>
                <span class="progress-percentage" id="ebook-progress-percent-{{ ebook_id }}">0%</span>
            </div>

            <!-- Font size controls -->
            <div class="font-controls">
                <button class="btn btn-sm"
                        _="on click call ebookViewer.decreaseFontSize('{{ ebook_id }}')"
                        title="Decrease Font Size">
                    A-
                </button>
                <span class="font-size-label" id="ebook-font-size-{{ ebook_id }}">100%</span>
                <button class="btn btn-sm"
                        _="on click call ebookViewer.increaseFontSize('{{ ebook_id }}')"
                        title="Increase Font Size">
                    A+
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Password Prompt Modal (nested, for encrypted PDFs) -->
<div class="ebook-password-modal" id="ebook-password-modal-{{ ebook_id }}" style="display: none;">
    <div class="password-modal-overlay" _="on click remove #ebook-password-modal-{{ ebook_id }}"></div>
    <div class="password-modal-content">
        <div class="password-modal-header">
            <h3>üîí Password Required</h3>
            <button class="btn btn-icon"
                    _="on click remove #ebook-password-modal-{{ ebook_id }}">
                <span class="icon">‚úï</span>
            </button>
        </div>
        <div class="password-modal-body">
            <p>This PDF is password-protected. Please enter the password to view it.</p>
            <form hx-post="/api/ebooks/{{ ebook_id }}/decrypt"
                  hx-swap="none"
                  _="on htmx:afterRequest
                     if detail.successful
                       then remove #ebook-password-modal-{{ ebook_id }}
                            call ebookViewer.reload('{{ ebook_id }}')
                     else add .shake to #password-input-{{ ebook_id }}
                          wait 500ms
                          remove .shake from #password-input-{{ ebook_id }}">
                <input type="password"
                       id="password-input-{{ ebook_id }}"
                       name="password"
                       class="password-input"
                       placeholder="Enter password..."
                       required
                       autocomplete="off"
                       _="on keydown
                          if event.key is 'Escape'
                            then remove #ebook-password-modal-{{ ebook_id }}">
                <div class="password-error" id="password-error-{{ ebook_id }}" style="display: none;">
                    <span class="error-icon">‚ö†Ô∏è</span>
                    <span class="error-text">Incorrect password. Please try again.</span>
                </div>
                <div class="password-attempts" id="password-attempts-{{ ebook_id }}">
                    Attempts remaining: <span id="password-attempts-count-{{ ebook_id }}">3</span>
                </div>
                <div class="password-actions">
                    <button type="submit" class="btn btn-primary">
                        Unlock
                    </button>
                    <button type="button"
                            class="btn btn-secondary"
                            _="on click remove #ebook-password-modal-{{ ebook_id }}">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Ebook Viewer Styles */
.ebook-viewer {
    position: fixed;
    top: 5%;
    left: 5%;
    right: 5%;
    bottom: 5%;
    display: flex;
    flex-direction: column;
    background: var(--secondary-bg);
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 8px 32px var(--shadow);
    z-index: 900;
    animation: slideIn 0.3s ease-out;
}

.ebook-viewer.fullscreen {
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: 0;
    z-index: 1000;
}

/* Header */
.ebook-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    background: var(--accent-bg);
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0;
}

.ebook-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
    min-width: 0;
}

.ebook-title-group {
    display: flex;
    flex-direction: column;
    min-width: 0;
}

.ebook-title {
    font-weight: 600;
    font-size: 1rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.ebook-author {
    font-size: 0.875rem;
    color: var(--secondary-text);
    font-style: italic;
}

.ebook-meta {
    font-size: 0.875rem;
    color: var(--secondary-text);
    white-space: nowrap;
}

.ebook-controls {
    display: flex;
    gap: 0.25rem;
    flex-shrink: 0;
}

/* Container with TOC */
.ebook-container {
    flex: 1;
    display: flex;
    overflow: hidden;
    position: relative;
}

.ebook-toc {
    width: 250px;
    background: var(--accent-bg);
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    z-index: 10;
}

.ebook-viewer.toc-visible .ebook-toc {
    transform: translateX(0);
}

.toc-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
}

.toc-header h4 {
    margin: 0;
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--secondary-text);
}

.toc-nav {
    flex: 1;
    overflow-y: auto;
    padding: 0.5rem;
}

.toc-loading {
    padding: 1rem;
    text-align: center;
    color: var(--secondary-text);
    font-size: 0.875rem;
}

.toc-link {
    display: block;
    padding: 0.5rem 0.75rem;
    color: var(--text-color);
    text-decoration: none;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    transition: background-color 0.2s;
    cursor: pointer;
}

.toc-link:hover {
    background: var(--hover-bg);
}

.toc-link.active {
    background: var(--primary-color);
    color: white;
}

.toc-link.toc-level-1 { padding-left: 0.75rem; }
.toc-link.toc-level-2 { padding-left: 1.5rem; font-size: 0.8125rem; }
.toc-link.toc-level-3 { padding-left: 2.25rem; font-size: 0.8125rem; }

/* Content Area */
.ebook-content {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: var(--terminal-bg);
}

.ebook-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--secondary-text);
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid var(--border-color);
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 1rem;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-progress {
    width: 300px;
    margin-top: 1rem;
}

.progress-bar {
    height: 4px;
    background: var(--border-color);
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.progress-fill {
    height: 100%;
    background: var(--primary-color);
    transition: width 0.3s ease;
}

.progress-text {
    font-size: 0.875rem;
    color: var(--secondary-text);
}

.foliate-viewer-container {
    width: 100%;
    height: 100%;
}

.ebook-error {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 2rem;
    text-align: center;
}

.ebook-error .error-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.ebook-error h3 {
    margin: 0 0 0.5rem 0;
    color: var(--error-color);
}

.ebook-error .error-message {
    color: var(--secondary-text);
    margin-bottom: 1.5rem;
}

/* Search Bar */
.ebook-search {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    background: var(--accent-bg);
    border-bottom: 1px solid var(--border-color);
    padding: 0.75rem 1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    transform: translateY(-100%);
    transition: transform 0.3s ease;
    z-index: 20;
}

.ebook-viewer.search-visible .ebook-search {
    transform: translateY(0);
}

.ebook-search .search-input {
    flex: 1;
    padding: 0.5rem 0.75rem;
    background: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 0.25rem;
    color: var(--text-color);
    font-size: 0.875rem;
}

.ebook-search .search-input:focus {
    outline: none;
    border-color: var(--primary-color);
}

.search-results {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.search-count {
    font-size: 0.875rem;
    color: var(--secondary-text);
    white-space: nowrap;
}

.search-nav {
    display: flex;
    gap: 0.25rem;
}

/* Footer */
.ebook-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    background: var(--accent-bg);
    border-top: 1px solid var(--border-color);
    flex-shrink: 0;
    gap: 1rem;
}

.ebook-navigation {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.page-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.page-info {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.875rem;
}

.page-input {
    width: 60px;
    padding: 0.25rem 0.5rem;
    background: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 0.25rem;
    color: var(--text-color);
    text-align: center;
    font-size: 0.875rem;
}

.page-input:focus {
    outline: none;
    border-color: var(--primary-color);
}

.ebook-actions {
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.reading-progress {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.progress-label {
    font-size: 0.875rem;
    color: var(--secondary-text);
}

.progress-bar-mini {
    width: 100px;
    height: 4px;
    background: var(--border-color);
    border-radius: 2px;
    overflow: hidden;
}

.progress-fill-mini {
    height: 100%;
    background: var(--primary-color);
    transition: width 0.3s ease;
}

.progress-percentage {
    font-size: 0.875rem;
    font-weight: 500;
    min-width: 2.5rem;
    text-align: right;
}

.font-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.font-size-label {
    font-size: 0.875rem;
    min-width: 2.5rem;
    text-align: center;
}

/* Password Modal */
.ebook-password-modal {
    position: fixed;
    inset: 0;
    z-index: 1100;
    display: flex;
    align-items: center;
    justify-content: center;
}

.password-modal-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    animation: fadeIn 0.2s ease-out;
}

.password-modal-content {
    position: relative;
    background: var(--secondary-bg);
    border-radius: 0.5rem;
    box-shadow: 0 8px 32px var(--shadow);
    width: 90%;
    max-width: 400px;
    animation: scaleIn 0.3s ease-out;
}

.password-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border-color);
}

.password-modal-header h3 {
    margin: 0;
    font-size: 1.125rem;
}

.password-modal-body {
    padding: 1.5rem 1.25rem;
}

.password-modal-body p {
    margin: 0 0 1.5rem 0;
    color: var(--secondary-text);
}

.password-modal-body form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.password-input {
    width: 100%;
    padding: 0.75rem;
    background: var(--terminal-bg);
    border: 1px solid var(--border-color);
    border-radius: 0.25rem;
    color: var(--text-color);
    font-size: 1rem;
}

.password-input:focus {
    outline: none;
    border-color: var(--primary-color);
}

.password-input.shake {
    animation: shake 0.5s;
}

.password-error {
    padding: 0.75rem;
    background: var(--error-bg);
    border: 1px solid var(--error-color);
    border-radius: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.password-error .error-text {
    font-size: 0.875rem;
    color: var(--error-color);
}

.password-attempts {
    font-size: 0.875rem;
    color: var(--secondary-text);
}

.password-actions {
    display: flex;
    gap: 0.75rem;
}

.password-actions .btn {
    flex: 1;
}

/* Animations */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes scaleIn {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}

/* Responsive */
@media (max-width: 768px) {
    .ebook-viewer {
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border-radius: 0;
    }

    .ebook-toc {
        width: 200px;
    }

    .ebook-footer {
        flex-direction: column;
        gap: 0.75rem;
        align-items: stretch;
    }

    .reading-progress {
        justify-content: center;
    }

    .font-controls {
        justify-content: center;
    }
}
</style>
